<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE LIFE OF AKA KOBI - GARAGE RUSH</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syncopate:wght@700&display=swap');
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Syncopate', sans-serif; color: #fff; }
        
        .screen {
            position: fixed; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 10000; 
            background: #000; text-align: center; padding: 20px;
        }
        
        .intro-logo {
            width: 500px; max-width: 80%; height: auto; margin-bottom: 40px;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
            animation: logoFloat 3s infinite ease-in-out;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); filter: brightness(1); }
            50% { transform: translateY(-15px); filter: brightness(1.2); }
        }

        h1 { color: #ffd700; font-size: 2.8rem; margin-bottom: 10px; text-shadow: 0 0 25px rgba(255,215,0,0.6); }
        
        #new-record-tag {
            color: #00ff00; font-size: 1.5rem; margin-bottom: 10px;
            display: none; animation: flash 0.5s infinite;
        }
        @keyframes flash { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.1); } }

        p { max-width: 600px; line-height: 1.8; color: #ccc; margin-bottom: 30px; font-size: 0.85rem; }

        .gold-btn { 
            background: #ffd700; color: #000; border: none; padding: 20px 60px; 
            font-size: 1.2rem; cursor: pointer; font-weight: 900; 
            text-transform: uppercase; letter-spacing: 4px;
            box-shadow: 0 0 30px rgba(255,215,0,0.4); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .gold-btn:hover { background: #fff; transform: scale(1.1); box-shadow: 0 0 50px #fff; }
        .gold-btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        #hud { 
            position: fixed; top: 20px; left: 20px; display: none; z-index: 100;
            background: rgba(0,0,0,0.85); padding: 20px; border-left: 5px solid #ffd700;
        }
        .hud-item { margin-bottom: 8px; font-size: 0.8rem; letter-spacing: 1px; }
        #boost-container { width: 160px; height: 10px; background: #222; border: 1px solid #444; margin-top: 12px; }
        #boost-bar { width: 100%; height: 100%; background: #00ff00; transition: width 0.1s linear; }

        #radar-container {
            position: fixed; bottom: 25px; right: 25px; width: 180px; height: 180px;
            background: rgba(0, 10, 0, 0.9); border: 2px solid #ffd700;
            border-radius: 50%; display: none; z-index: 100;
        }
    </style>
</head>
<body>

<div id="gate" class="screen">
    <img src="logo.png" alt="AKA KOBI" class="intro-logo" onerror="this.style.display='none'">
    <h1>GARAGE RUSH</h1>
    <button class="gold-btn" id="enter-btn">ENTER ARENA</button>
</div>

<div id="briefing" class="screen" style="display:none;">
    <h1>MISSION BRIEFING</h1>
    <p>OBJECTIVE: RECOVER 12 EXPERIMENTAL WRENCHES.<br>TIME LIMIT: 90 SECONDS<br><br><span id="load-status" style="color:#ffd700;">INITIALIZING HIGH-RES SHADERS...</span></p>
    <div id="best-time-display" style="color: #ffd700; margin-bottom: 20px; font-size: 0.9rem;"></div>
    <button class="gold-btn" id="start-btn" disabled>START MISSION</button>
</div>

<div id="game-over" class="screen" style="display:none;">
    <div id="new-record-tag">★ NEW PERSONAL BEST ★</div>
    <h1 id="result-title">MISSION COMPLETE</h1>
    <div id="stats" style="margin-bottom: 30px; font-size: 1.2rem;"></div>
    <button class="gold-btn" onclick="location.reload()">RETRY</button>
</div>

<div id="hud">
    <div class="hud-item">TOOLS RECOVERED: <span id="count" style="color:#ffd700">0</span>/12</div>
    <div class="hud-item" style="font-size: 1.6rem; margin: 12px 0; font-weight: 900;">TIME: <span id="timer">1:30</span></div>
    <div class="hud-item">SCORE: <span id="score" style="color:#ffd700">0</span></div>
    <div id="boost-container"><div id="boost-bar"></div></div>
    <div id="boost-text" style="font-size: 0.6rem; margin-top: 5px; color: #00ff00;">BOOST READY</div>
</div>

<div id="radar-container"><canvas id="radar-canvas" width="180" height="180"></canvas></div>

<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
import { GLTFLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/GLTFLoader.js';
import { DRACOLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/DRACOLoader.js';

class GarageGame {
    constructor() {
        this.active = false;
        this.items = [];
        this.score = 0;
        this.startTime = 90;
        this.timeLeft = 90;
        this.collected = 0;
        this.keys = {};
        this.isBoosting = false;
        this.boostReady = true;
        this.boostValue = 100;
        
        this.pingSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3');
        this.pingSound.volume = 0.15; 

        this.initThree();
        this.updateBestTimeDisplay();
    }

    updateBestTimeDisplay() {
        const best = localStorage.getItem('kobi_best_time');
        const display = document.getElementById('best-time-display');
        if (best) display.innerText = `PERSONAL BEST: ${best}s`;
    }

    initThree() {
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x010103);
        this.scene.fog = new THREE.FogExp2(0x010103, 0.005);
        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
        this.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
        this.renderer.toneMappingExposure = 1.25;
        this.renderer.outputEncoding = THREE.sRGBEncoding;
        document.body.appendChild(this.renderer.domElement);

        this.scene.add(new THREE.HemisphereLight(0xffd700, 0x000033, 1.5));
        this.scene.add(new THREE.AmbientLight(0x404040, 0.5));

        this.player = new THREE.Group();
        const pMesh = new THREE.Mesh(
            new THREE.ConeGeometry(0.4, 1.3, 4), 
            new THREE.MeshStandardMaterial({ color: 0xffd700, emissive: 0xffd700, emissiveIntensity: 10, metalness: 0.8, roughness: 0.2 })
        );
        pMesh.rotation.x = Math.PI/2;
        this.player.add(pMesh);
        this.player.add(new THREE.PointLight(0xffd700, 20, 25));

        this.player.position.set(212.2, 0.8, -236.5);
        this.player.rotation.y = Math.PI; 
        this.scene.add(this.player);

        window.addEventListener('keydown', e => {
            this.keys[e.code] = true;
            if(e.code === 'Space' && this.boostReady && this.active) this.triggerBoost();
        });
        window.addEventListener('keyup', e => this.keys[e.code] = false);
        this.ctx = document.getElementById('radar-canvas').getContext('2d');
        this.animate();
    }

    triggerBoost() {
        this.isBoosting = true; this.boostReady = false;
        document.getElementById('boost-text').innerText = "BOOSTING...";
        let blast = setInterval(() => {
            this.boostValue -= 4;
            if(this.boostValue <= 0) { clearInterval(blast); this.isBoosting = false; this.startCooldown(); }
        }, 80);
    }

    startCooldown() {
        document.getElementById('boost-text').innerText = "RECHARGING...";
        let recharge = setInterval(() => {
            this.boostValue += 2;
            if(this.boostValue >= 100) { clearInterval(recharge); this.boostReady = true; document.getElementById('boost-text').innerText = "BOOST READY"; }
        }, 100);
    }

    spawnWrenches() {
        const metal = new THREE.MeshStandardMaterial({ color: 0xffffff, metalness: 0.9, roughness: 0.1, emissive: 0xffffff, emissiveIntensity: 2 });
        for(let i=0; i<12; i++) {
            const group = new THREE.Group();
            const head = new THREE.Mesh(new THREE.TorusGeometry(0.28, 0.08, 8, 12, Math.PI * 1.6), metal);
            const handle = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.75, 0.1), metal);
            handle.position.y = -0.45;
            group.add(head, handle);
            const ring = new THREE.Mesh(new THREE.TorusGeometry(0.8, 0.02, 16, 40), new THREE.MeshBasicMaterial({ color: 0xff6600 }));
            ring.rotation.x = Math.PI/2;
            group.add(ring);
            
            const angle = Math.random() * 6.28;
            const dist = 30 + Math.random() * 250;
            group.position.set(212.2 + Math.cos(angle)*dist, 1.6, -236.5 + Math.sin(angle)*dist);
            
            this.items.push(group);
            this.scene.add(group);
        }
    }

    animate() {
        requestAnimationFrame(() => this.animate());
        if(this.active) {
            let speed = this.isBoosting ? 1.85 : 0.62;
            if(this.keys['KeyW']) this.player.translateZ(-speed);
            if(this.keys['KeyS']) this.player.translateZ(speed*0.5);
            if(this.keys['KeyA']) this.player.rotation.y += 0.065;
            if(this.keys['KeyD']) this.player.rotation.y -= 0.065;

            document.getElementById('boost-bar').style.width = this.boostValue + "%";
            this.items.forEach(w => {
                if(w.visible && this.player.position.distanceTo(w.position) < 6) {
                    w.visible = false;
                    const s = this.pingSound.cloneNode(); s.volume = 0.15; s.play().catch(()=>{});
                    this.collected++;
                    this.score += 200;
                    document.getElementById('count').innerText = this.collected;
                    document.getElementById('score').innerText = this.score;
                    if(this.collected >= 12) this.endGame(true);
                }
            });

            const ctx = this.ctx; ctx.clearRect(0,0,180,180);
            this.items.forEach(item => {
                if(item.visible) {
                    ctx.fillStyle = "#fff"; ctx.beginPath();
                    ctx.arc(90 + (item.position.x - this.player.position.x)*0.25, 90 + (item.position.z - this.player.position.z)*0.25, 2, 0, 7);
                    ctx.fill();
                }
            });
            ctx.fillStyle = "#ffd700"; ctx.beginPath(); ctx.arc(90,90,5,0,7); ctx.fill();
        }
        const camOff = new THREE.Vector3(0, 5, 12).applyQuaternion(this.player.quaternion);
        this.camera.position.lerp(this.player.position.clone().add(camOff), 0.1);
        this.camera.lookAt(this.player.position);
        this.renderer.render(this.scene, this.camera);
    }

    endGame(win) {
        this.active = false;
        const timeTaken = this.startTime - this.timeLeft;
        let isNewRecord = false;
        if (win) {
            const best = localStorage.getItem('kobi_best_time');
            if (!best || timeTaken < parseInt(best)) {
                localStorage.setItem('kobi_best_time', timeTaken);
                isNewRecord = true;
            }
        }
        document.getElementById('hud').style.display = 'none';
        document.getElementById('radar-container').style.display = 'none';
        document.getElementById('game-over').style.display = 'flex';
        document.getElementById('new-record-tag').style.display = isNewRecord ? 'block' : 'none';
        document.getElementById('result-title').innerText = win ? "MISSION COMPLETE" : "MISSION FAILED";
        document.getElementById('stats').innerHTML = `SCORE: ${this.score}<br>TIME TAKEN: ${timeTaken}s`;
    }
}

const game = new GarageGame();

document.getElementById('enter-btn').onclick = () => {
    document.getElementById('gate').style.display = 'none';
    document.getElementById('briefing').style.display = 'flex';
    
    // Setup DRACO loader for compressed models
    const dracoLoader = new DRACOLoader();
    dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
    
    // Try loading with timeout and better error handling
    const loader = new GLTFLoader();
    loader.setDRACOLoader(dracoLoader);
    
    let loadTimeout;
    let hasLoaded = false;
    
    // Set 30 second timeout
    loadTimeout = setTimeout(() => {
        if (!hasLoaded) {
            console.warn('Arena load timeout - using fallback');
            document.getElementById('load-status').innerText = "⚠️ LOAD TIMEOUT - Using basic environment";
            document.getElementById('load-status').style.color = "#ffaa00";
            createFallbackEnvironment();
        }
    }, 30000);
    
    function createFallbackEnvironment() {
        hasLoaded = true;
        // Create fallback ground plane
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(500, 500),
            new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.8 })
        );
        ground.rotation.x = -Math.PI/2;
        game.scene.add(ground);
        
        // Add some basic walls so it feels like a garage
        const wallMat = new THREE.MeshStandardMaterial({ color: 0x2a2a2a, roughness: 0.9 });
        const wall1 = new THREE.Mesh(new THREE.BoxGeometry(500, 30, 2), wallMat);
        wall1.position.set(0, 15, -250);
        const wall2 = new THREE.Mesh(new THREE.BoxGeometry(500, 30, 2), wallMat);
        wall2.position.set(0, 15, 250);
        const wall3 = new THREE.Mesh(new THREE.BoxGeometry(2, 30, 500), wallMat);
        wall3.position.set(-250, 15, 0);
        const wall4 = new THREE.Mesh(new THREE.BoxGeometry(2, 30, 500), wallMat);
        wall4.position.set(250, 15, 0);
        game.scene.add(wall1, wall2, wall3, wall4);
        
        game.spawnWrenches();
        document.getElementById('start-btn').disabled = false;
    }
    
    loader.load(
        'https://dl.dropboxusercontent.com/scl/fi/6ra7lo5htqjecxlv6w99f/arena.glb?rlkey=iqwd9sj1fva3k8t3z8fy9e9x2&raw=1&st=download',
        (gltf) => {
            clearTimeout(loadTimeout);
            hasLoaded = true;
            console.log('Arena loaded successfully!');
            game.scene.add(gltf.scene);
            game.spawnWrenches();
            document.getElementById('load-status').innerText = "OPTICS OPTIMIZED";
            document.getElementById('start-btn').disabled = false;
        },
        (progress) => {
            if (progress.total > 0) {
                const percent = Math.round((progress.loaded / progress.total) * 100);
                document.getElementById('load-status').innerText = `LOADING ARENA: ${percent}% (${Math.round(progress.loaded/1048576)}MB)`;
            } else {
                document.getElementById('load-status').innerText = `LOADING: ${Math.round(progress.loaded/1048576)}MB...`;
            }
        },
        (error) => {
            clearTimeout(loadTimeout);
            hasLoaded = true;
            console.error('Arena loading error:', error);
            document.getElementById('load-status').innerText = "⚠️ ARENA FILE ERROR - Using basic environment";
            document.getElementById('load-status').style.color = "#ff0000";
            createFallbackEnvironment();
        }
    );
    
    const audio = new Audio('https://dl.dropboxusercontent.com/scl/fi/lg4b8xgncie3x1b1ez4h8/Igzotic-Money-chaser-Official-Music-Video.mp3?rlkey=umjddw56vwumbnd2qjkg0ft2e&raw=1');
    audio.loop = true; audio.play().catch(()=>{});
};

document.getElementById('start-btn').onclick = () => {
    document.getElementById('briefing').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    document.getElementById('radar-container').style.display = 'block';
    game.active = true;
    const timerInt = setInterval(() => { 
        if(!game.active) { clearInterval(timerInt); return; }
        game.timeLeft--; 
        let m = Math.floor(game.timeLeft/60), s = game.timeLeft%60;
        document.getElementById('timer').innerText = `${m}:${s.toString().padStart(2,'0')}`;
        if(game.timeLeft <= 0) game.endGame(false);
    }, 1000);
};
</script>
</body>
</html>